<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI4I PII Guardrail v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #ffffff; padding-top: 20px; font-family: 'Segoe UI', sans-serif; }
        
        /* --- Layout Styles --- */
        .nav-tabs { border-bottom: 2px solid #dee2e6; }
        .nav-tabs .nav-link { color: #495057; font-weight: 500; }
        .nav-tabs .nav-link.active { border-color: #dee2e6 #dee2e6 #fff; color: #000; font-weight: 700; }
        
        .section-label { font-weight: 700; color: #212529; margin-bottom: 8px; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .rule-list { border: 1px solid #dee2e6; border-radius: 4px; padding: 0; max-height: 250px; overflow-y: auto; background: #f8f9fa; }
        .rule-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #e9ecef; }
        .standard-tag { color: #6c757d; font-size: 0.85rem; margin-left: 10px; font-style: italic; }

        .output-label { color: #198754; font-weight: 700; font-size: 1rem; margin-bottom: 10px; } 
        .latency-badge { background-color: #ffc107; color: #000; font-weight: 600; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; vertical-align: middle; margin-left: 10px; }
        .output-box { border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; min-height: 100px; color: #6c757d; background: #fff; font-size: 1rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        
        .audit-label { font-weight: 700; color: #000; margin-top: 20px; margin-bottom: 10px; }
        .audit-box { background: #0f0f0f; color: #00ff41; padding: 15px; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 0.85rem; min-height: 300px; white-space: pre-wrap; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* --- Workflow Overlay Styles --- */
        .workflow-wrapper { position: relative; }
        
        .workflow-active .workflow-wrapper {
            border: 2px dashed #0d6efd;
            border-radius: 8px;
            padding: 5px;
            margin: -7px;
            background: rgba(13, 110, 253, 0.03);
        }

        .workflow-badge {
            display: none; position: absolute; z-index: 105;
            background: #0d6efd; color: white; width: 26px; height: 26px; border-radius: 50%;
            text-align: center; line-height: 26px; font-weight: bold; font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .workflow-desc {
            display: none; position: absolute; z-index: 100;
            background: #0d6efd; color: white; padding: 8px 12px; border-radius: 4px;
            font-size: 0.85rem; width: 220px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            line-height: 1.3;
        }
        
        .workflow-desc::after { content: ""; position: absolute; border-width: 6px; border-style: solid; }

        .workflow-active .workflow-badge, .workflow-active .workflow-desc { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Badge Positioning */
        #badge-1 { top: -13px; left: -13px; }
        #desc-1 { top: -55px; left: 0; } 
        #desc-1::after { bottom: -12px; left: 10px; border-color: #0d6efd transparent transparent transparent; }

        #badge-2 { top: -13px; left: -13px; }
        #desc-2 { top: -55px; left: 0; width: 300px; } 
        #desc-2::after { bottom: -12px; left: 10px; border-color: #0d6efd transparent transparent transparent; }

        #badge-3 { top: 35px; left: -13px; }
        #desc-3 { top: 65px; left: -10px; z-index: 110; } 
        #desc-3::after { top: -12px; left: 10px; border-color: transparent transparent #0d6efd transparent; }

        #badge-4 { top: -13px; right: -13px; }
        #desc-4 { top: -65px; right: 0; width: 280px; } 
        #desc-4::after { bottom: -12px; right: 10px; border-color: #0d6efd transparent transparent transparent; }

        #badge-5 { top: 20px; right: -13px; }
        #desc-5 { top: -20px; right: 0; width: 200px; text-align: right; } 
        #desc-5::after { bottom: -12px; right: 10px; border-color: #0d6efd transparent transparent transparent; }

    </style>
</head>
<body>

<div class="container mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <div>
            <h3 class="fw-bold text-dark mb-0">üõ°Ô∏è AI4I PII Guardrail</h3>
            <span class="badge bg-dark rounded-pill px-3 py-1">v2.1 Enterprise</span>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="workflowToggle" onchange="toggleWorkflow()">
            <label class="form-check-label fw-bold small text-primary" for="workflowToggle">SHOW WORKFLOW INFO</label>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#demo-pane">üéÆ Playground</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin-pane">‚öôÔ∏è Policy Manager</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="demo-pane">
            <div class="row gx-5">
                <div class="col-lg-5">
                    
                    <div class="mb-4 workflow-wrapper">
                        <div class="workflow-badge" id="badge-1">1</div>
                        <div id="desc-1" class="workflow-desc">
                            The domain is fetched from the policy engine (Only ACTIVE domains).
                        </div>
                        <label class="section-label">Select Domain Policy</label>
                        <select class="form-select" id="domainSelect"></select>
                    </div>

                    <div class="mb-4 workflow-wrapper">
                        <div class="workflow-badge" id="badge-2">2</div>
                        <div id="desc-2" class="workflow-desc">
                            The redaction rules associated with the selected Domain.
                        </div>
                        <label class="section-label">üìú Active Rules</label>
                        <div class="rule-list" id="policyList"></div>
                    </div>

                    <div class="mb-3 workflow-wrapper">
                        <div class="workflow-badge" id="badge-3">3</div>
                        <div id="desc-3" class="workflow-desc">
                            Text to be redacted, passed from the calling service.
                        </div>
                        <label class="section-label">Input Text</label>
                        <textarea class="form-control" id="inputText" rows="5" placeholder="Enter text to be redacted...">Patient John Doe (ID: UHID123456) diagnosed with E11.9. Contact: +91 9876543210.</textarea>
                    </div>
                    
                    <button class="btn btn-primary w-100 fw-bold py-2 shadow-sm" onclick="runRedaction()">Run Redaction</button>
                </div>

                <div class="col-lg-7">
                    <div class="workflow-wrapper mb-4">
                        <div class="workflow-badge" id="badge-4">4</div>
                        <div id="desc-4" class="workflow-desc">
                            Redacted Text that will be sent back to the calling service.
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <span class="output-label">Sanitized Output</span>
                            <span id="latencyBadge" class="latency-badge" style="display:none">‚ö° 0 ms</span>
                        </div>
                        <div id="outputText" class="output-box">...</div>
                    </div>

                    <div class="workflow-wrapper">
                        <div class="workflow-badge" id="badge-5">5</div>
                        <div id="desc-5" class="workflow-desc">
                            Logs for Audit Purpose.
                        </div>
                        <div class="audit-label">Audit Logs (JSON)</div>
                        <div id="jsonOutput" class="audit-box">Waiting for request...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="admin-pane">
            <div class="row g-4">
                
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white fw-bold">1. Select Domain Template</div>
                        <div class="card-body">
                            <label class="small text-muted mb-2">Available Domains (Inactive & Active)</label>
                            <div class="list-group" id="adminDomainList">
                                </div>
                            
                            <hr class="my-3">
                            <h6 class="fw-bold">Create New Scope</h6>
                            <input type="text" class="form-control mb-2 form-control-sm" id="newDomainId" placeholder="New Domain ID (e.g. legal)">
                            <input type="text" class="form-control mb-2 form-control-sm" id="newDomainDesc" placeholder="Description">
                            <button class="btn btn-outline-dark btn-sm w-100" onclick="createDomain()">+ Create Empty Scope</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                            <span>2. Configure Rules & Deploy</span>
                            <span class="badge bg-warning text-dark" id="editStatusBadge" style="display:none">Editing: finance</span>
                        </div>
                        <div class="card-body">
                            
                            <div class="border rounded p-2 mb-3 bg-light" style="height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 40px">Act</th>
                                            <th>Entity Type</th>
                                            <th>Action</th>
                                            <th>Config</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ruleChecklistBody">
                                        <tr><td colspan="4" class="text-center text-muted mt-3">Select a domain from the left to load rules.</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="card bg-white border p-2 mb-3">
                                <h6 class="small fw-bold text-primary">Add Custom Rule</h6>
                                <div class="row g-2">
                                    <div class="col-md-3"><input type="text" class="form-control form-control-sm" id="newRuleEntity" placeholder="Entity (e.g. TICKET_ID)"></div>
                                    <div class="col-md-2">
                                        <select class="form-select form-select-sm" id="newRuleAction">
                                            <option value="REDACT_TAG">TAG</option>
                                            <option value="MASK">MASK</option>
                                            <option value="HASH">HASH</option>
                                        </select>
                                    </div>
                                    <div class="col-md-7">
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control" id="aiExample" placeholder="Example: Ticket #AB-123">
                                            <button class="btn btn-outline-secondary" onclick="generateRegexPreview()">Gen Regex</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-2 mt-2">
                                    <div class="col-12">
                                        <input type="text" class="form-control form-control-sm font-monospace bg-light" id="newRuleRegex" placeholder="Regex will appear here..." readonly>
                                    </div>
                                    <div class="col-12">
                                        <button class="btn btn-sm btn-outline-primary w-100" onclick="addCustomRuleToUI()">+ Add to Checklist</button>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-success w-100 fw-bold py-2" onclick="deployDomain()">üíæ Save Policy & Activate Domain</button>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- UI HELPERS ---
    function toggleWorkflow() {
        const isActive = document.getElementById('workflowToggle').checked;
        const wrappers = document.querySelectorAll('.workflow-wrapper');
        wrappers.forEach(el => {
            if(isActive) el.classList.add('workflow-active');
            else el.classList.remove('workflow-active');
        });
    }

    // --- PLAYGROUND LOGIC ---
    async function loadDomains() {
        try {
            const res = await fetch('/domains');
            const domains = await res.json();
            const sel = document.getElementById('domainSelect');
            sel.innerHTML = '';
            if (domains.length === 0) {
                sel.innerHTML = '<option>No Active Domains</option>';
            } else {
                domains.forEach(d => sel.innerHTML += `<option value="${d}">${d.toUpperCase()}</option>`);
                loadPolicy(); 
            }
        } catch(e) { console.error("Failed to load domains", e); }
    }

    async function loadPolicy() {
        const domain = document.getElementById('domainSelect').value;
        if (!domain || domain === 'No Active Domains') return;
        const res = await fetch(`/policy/${domain}`);
        const data = await res.json();
        const list = document.getElementById('policyList');
        list.innerHTML = '';
        if(data.rules) {
            data.rules.forEach(r => {
                let badgeClass = "bg-secondary";
                if(r.action === "MASK") badgeClass = "bg-dark";
                if(r.action === "HASH") badgeClass = "bg-danger";
                list.innerHTML += `
                    <div class="rule-item">
                        <span class="rule-name">${r.entity_type}</span>
                        <div>
                            <span class="badge ${badgeClass} badge-action me-1">${r.action}</span>
                            <span class="standard-tag">Standard</span>
                        </div>
                    </div>`;
            });
        }
    }

    async function runRedaction() {
        const text = document.getElementById('inputText').value;
        const domain = document.getElementById('domainSelect').value;
        const tenantId = "bhashini-demo"; 
        
        if (!domain || domain === 'No Active Domains') return alert("Please activate a domain in Policy Manager first.");

        document.getElementById('outputText').innerText = "Processing...";
        document.getElementById('latencyBadge').style.display = 'none';
        try {
            const res = await fetch('/redact', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-Tenant-ID': tenantId},
                body: JSON.stringify({text, domain})
            });
            if (!res.ok) {
                const err = await res.json();
                document.getElementById('outputText').innerHTML = `<span class="text-danger">‚õî ${err.detail}</span>`;
                return;
            }
            const data = await res.json();
            document.getElementById('outputText').innerText = data.redacted_text;
            document.getElementById('jsonOutput').innerText = JSON.stringify(data, null, 4);
            const badge = document.getElementById('latencyBadge');
            badge.innerText = `‚ö° ${data.metadata.processing_time_ms} ms`;
            badge.style.display = 'inline-block';
        } catch (e) { alert("System Error: " + e); }
    }

    // --- ADMIN LOGIC ---
    let currentAdminRules = []; 
    let currentDomainId = null;

    async function loadAdminDomains() {
        try {
            const res = await fetch('/admin/all-domains');
            const domains = await res.json();
            const list = document.getElementById('adminDomainList');
            list.innerHTML = '';
            domains.forEach(d => {
                const statusDot = d.is_active ? 'üü¢' : '‚ö™';
                const activeClass = d.is_active ? 'fw-bold text-dark' : 'text-muted';
                list.innerHTML += `
                    <button class="list-group-item list-group-item-action py-2" onclick="loadDomainConfig('${d.domain_id}')">
                        <div class="d-flex w-100 justify-content-between">
                            <span class="${activeClass}">${d.domain_id.toUpperCase()}</span>
                            <span>${statusDot}</span>
                        </div>
                        <small class="text-muted" style="font-size:0.75rem">${d.description || ''}</small>
                    </button>`;
            });
        } catch(e) { console.error("Admin Load Error", e); }
    }

    async function loadDomainConfig(domainId) {
        currentDomainId = domainId;
        document.getElementById('editStatusBadge').innerText = `Editing: ${domainId}`;
        document.getElementById('editStatusBadge').style.display = 'inline-block';
        
        const res = await fetch(`/admin/domain-config/${domainId}`);
        const data = await res.json();
        
        currentAdminRules = data.policy_json.rules || [];
        renderChecklist();
    }

    function renderChecklist() {
        const tbody = document.getElementById('ruleChecklistBody');
        tbody.innerHTML = '';
        currentAdminRules.forEach((r, idx) => {
            let configStr = JSON.stringify(r.config);
            if(configStr.length > 20) configStr = configStr.substring(0,20) + '...';

            tbody.innerHTML += `
                <tr>
                    <td><input type="checkbox" class="form-check-input" checked id="rule-chk-${idx}"></td>
                    <td class="fw-bold" style="font-size:0.9rem">${r.entity_type}</td>
                    <td><span class="badge bg-secondary">${r.action}</span></td>
                    <td class="text-muted small font-monospace">${configStr}</td>
                </tr>
            `;
        });
    }

    async function generateRegexPreview() {
        const ex = document.getElementById('aiExample').value;
        if(!ex) return alert("Enter example text");
        document.getElementById('newRuleRegex').value = "Generating...";
        const res = await fetch('/admin/generate-regex', {method:'POST', body:JSON.stringify({example_text:ex}), headers:{'Content-Type':'application/json'}});
        const data = await res.json();
        if(res.ok) document.getElementById('newRuleRegex').value = data.regex;
        else alert(data.detail);
    }

    function addCustomRuleToUI() {
        const entity = document.getElementById('newRuleEntity').value;
        const action = document.getElementById('newRuleAction').value;
        const regex = document.getElementById('newRuleRegex').value;
        if(!entity || !regex) return alert("Entity Name and Regex are required");

        let config = {};
        if (action === "REDACT_TAG") config = { "tag_label": `[${entity}]` };
        if (action === "MASK") config = { "visible_suffix_length": 2, "mask_char": "X" };
        if (action === "HASH") config = { "algorithm": "HMAC-SHA256" };

        const newRule = {
            "entity_type": entity,
            "action": action,
            "config": config,
            "custom_regex": regex
        };

        currentAdminRules.push(newRule);
        renderChecklist(); 
        
        document.getElementById('newRuleEntity').value = "";
        document.getElementById('aiExample').value = "";
        document.getElementById('newRuleRegex').value = "";
    }

    async function deployDomain() {
        if(!currentDomainId) return alert("Please select a domain first.");
        
        const finalRules = [];
        currentAdminRules.forEach((rule, idx) => {
            const chk = document.getElementById(`rule-chk-${idx}`);
            if(chk && chk.checked) {
                finalRules.push(rule);
            }
        });

        if(finalRules.length === 0 && !confirm("Deploying with 0 rules?")) return;

        try {
            const res = await fetch('/admin/deploy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ domain_id: currentDomainId, rules: finalRules })
            });
            const data = await res.json();
            if(res.ok) {
                alert(`‚úÖ Success! Domain '${currentDomainId}' is now ACTIVE with ${data.active_rules_count} rules.`);
                loadAdminDomains(); 
                loadDomains(); 
            } else {
                alert("Error: " + data.detail);
            }
        } catch(e) { alert("Network Error: " + e); }
    }

    async function createDomain() {
        const id = document.getElementById('newDomainId').value;
        const desc = document.getElementById('newDomainDesc').value;
        if(!id) return alert("Domain ID is required");
        try {
            await fetch('/admin/domain', {method: 'POST', body: JSON.stringify({domain_id: id, description: desc}), headers: {'Content-Type': 'application/json'}});
            alert("Empty Scope Created. Select it from the list to add rules."); 
            loadAdminDomains();
        } catch(e) { alert("Network Error"); }
    }

    window.onload = function() {
        loadDomains(); 
        loadAdminDomains(); 
    };
</script>
</body>
</html>