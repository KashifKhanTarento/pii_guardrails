<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI4I PII Guardrail v2.2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding-top: 20px; font-family: 'Segoe UI', sans-serif; }
        
        /* --- Layout --- */
        .nav-tabs { border-bottom: 2px solid #dee2e6; }
        .nav-tabs .nav-link { color: #495057; font-weight: 500; }
        .nav-tabs .nav-link.active { border-color: #dee2e6 #dee2e6 #f4f6f9; color: #0d6efd; font-weight: 700; background: #f4f6f9; }
        
        /* --- Components --- */
        .section-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        .section-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; color: #6c757d; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        
        .rule-list { max-height: 200px; overflow-y: auto; }
        .rule-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8f9fa; }
        .rule-item:last-child { border-bottom: none; }
        
        .output-box { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; font-family: 'Consolas', monospace; color: #333; min-height: 80px; }
        
        /* --- NEW: Activity Log (Orchestration Trace) --- */
        .trace-container { background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; }
        .trace-header { background: #212529; color: #fff; padding: 12px 15px; font-weight: 700; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
        .trace-body { padding: 0; max-height: 500px; overflow-y: auto; background: #f8f9fa; }
        
        .trace-step { padding: 12px 15px; border-left: 4px solid transparent; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; position: relative; }
        .trace-step:hover { background: #e9ecef; }
        .trace-step.active { background: #fff; border-left-color: #0d6efd; }
        .trace-step.success { border-left-color: #198754; }
        .trace-step.error { border-left-color: #dc3545; background: #fff5f5; }
        
        .step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .step-name { font-weight: 600; font-size: 0.9rem; color: #333; }
        .step-time { font-size: 0.75rem; font-weight: 700; color: #6c757d; background: #e9ecef; padding: 2px 6px; border-radius: 4px; }
        .step-desc { font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .step-details { display: none; margin-top: 8px; font-size: 0.8rem; background: #333; color: #00ff41; padding: 10px; border-radius: 4px; font-family: 'Consolas', monospace; }
        .trace-step.expanded .step-details { display: block; animation: slideDown 0.2s; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center my-4">
        <div>
            <h3 class="fw-bold text-dark mb-0">üõ°Ô∏è AI4I PII Guardrail</h3>
            <span class="badge bg-primary rounded-pill px-3 py-1">v2.2 Enterprise Trace</span>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="traceToggle" checked>
            <label class="form-check-label fw-bold small text-secondary" for="traceToggle">LIVE ORCHESTRATION VIEW</label>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#demo-pane">üéÆ Guardrail Playground</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin-pane">‚öôÔ∏è Policy Manager</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="demo-pane">
            <div class="row gx-4">
                
                <div class="col-lg-4">
                    <div class="section-card">
                        <div class="section-title">1. Configuration</div>
                        <label class="small fw-bold mb-1">Select Domain</label>
                        <select class="form-select mb-3" id="domainSelect"></select>
                        
                        <label class="small fw-bold mb-1">Active Rules</label>
                        <div class="rule-list text-muted small" id="policyList">
                            Select a domain...
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-title">2. Input Data</div>
                        <textarea class="form-control" id="inputText" rows="6" placeholder="Paste unstructured text here (e.g. email bodies, chat logs)...">Student name is Kashif and ID is 9874651.</textarea>
                        <button class="btn btn-primary w-100 fw-bold mt-3 py-2 shadow-sm" onclick="runRedaction()">üõ°Ô∏è Run Protection</button>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="section-card h-100">
                        <div class="section-title">3. Secure Output</div>
                        <div id="outputText" class="output-box mb-3">...</div>
                        
                        <div class="d-flex justify-content-between align-items-center border-top pt-3">
                            <span class="small text-muted">Latency</span>
                            <span id="latencyBadge" class="badge bg-warning text-dark">0 ms</span>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="trace-container" id="tracePanel" style="display:none">
                        <div class="trace-header">
                            <span>üö¶ Activity Log</span>
                            <span class="badge bg-secondary" style="font-size:0.7rem">LIVE TRACE</span>
                        </div>
                        <div class="trace-body" id="traceList">
                            <div class="p-4 text-center text-muted small">
                                Waiting for request...
                            </div>
                        </div>
                    </div>
                    <div class="mt-3" id="jsonPanel">
                        <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#jsonCollapse">Show Raw JSON</button>
                        <div class="collapse mt-2" id="jsonCollapse">
                            <div class="card card-body bg-dark text-success font-monospace small p-2" id="jsonOutput"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="tab-pane fade" id="admin-pane">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="section-card h-100">
                        <div class="section-title">1. Select Template</div>
                        <div class="list-group" id="adminDomainList"></div>
                        <hr>
                        <input type="text" class="form-control mb-2 form-control-sm" id="newDomainId" placeholder="New Domain ID">
                        <button class="btn btn-outline-dark btn-sm w-100" onclick="createDomain()">+ Create Scope</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="section-card h-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="fw-bold">2. Configure & Deploy</span>
                            <span class="badge bg-warning text-dark" id="editStatusBadge" style="display:none">Editing</span>
                        </div>
                        <div class="border rounded p-2 mb-3 bg-light" style="height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light"><tr><th width="30"></th><th>Entity</th><th>Action</th><th>Config</th></tr></thead>
                                <tbody id="ruleChecklistBody"></tbody>
                            </table>
                        </div>
                        <div class="card bg-white border p-2 mb-3">
                            <h6 class="small fw-bold text-primary">Add Custom Rule</h6>
                            <div class="row g-2">
                                <div class="col-3"><input type="text" class="form-control form-control-sm" id="newRuleEntity" placeholder="Entity"></div>
                                <div class="col-2"><select class="form-select form-select-sm" id="newRuleAction"><option>REDACT_TAG</option><option>MASK</option><option>HASH</option></select></div>
                                <div class="col-7"><div class="input-group input-group-sm"><input type="text" class="form-control" id="aiExample" placeholder="Example"><button class="btn btn-outline-secondary" onclick="generateRegexPreview()">Gen Regex</button></div></div>
                            </div>
                            <input type="text" class="form-control form-control-sm mt-2 bg-light font-monospace" id="newRuleRegex" readonly>
                            <button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="addCustomRuleToUI()">+ Add to List</button>
                        </div>
                        <button class="btn btn-success w-100 fw-bold" onclick="deployDomain()">üíæ Save & Activate</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- STATE ---
    let currentAdminRules = []; 
    let currentDomainId = null;

    // --- PLAYGROUND ---
    async function loadDomains() {
        const res = await fetch('/domains');
        const domains = await res.json();
        const sel = document.getElementById('domainSelect');
        sel.innerHTML = '';
        if (domains.length === 0) sel.innerHTML = '<option>No Active Domains</option>';
        else {
            domains.forEach(d => sel.innerHTML += `<option value="${d}">${d.toUpperCase()}</option>`);
            loadPolicy();
        }
    }

    async function loadPolicy() {
        const domain = document.getElementById('domainSelect').value;
        if (!domain || domain === 'No Active Domains') return;
        const res = await fetch(`/policy/${domain}`);
        const data = await res.json();
        const list = document.getElementById('policyList');
        list.innerHTML = '';
        if(data.rules) {
            data.rules.forEach(r => {
                let badge = r.action === "MASK" ? "bg-dark" : (r.action === "HASH" ? "bg-danger" : "bg-secondary");
                list.innerHTML += `<div class="rule-item"><span>${r.entity_type}</span><span class="badge ${badge}">${r.action}</span></div>`;
            });
        }
    }

    async function runRedaction() {
        const text = document.getElementById('inputText').value;
        const domain = document.getElementById('domainSelect').value;
        const showTrace = document.getElementById('traceToggle').checked;
        
        if (!domain || domain === 'No Active Domains') return alert("Activate a domain first.");
        
        // Reset UI
        document.getElementById('outputText').innerText = "Processing...";
        if(showTrace) {
            document.getElementById('tracePanel').style.display = 'block';
            document.getElementById('traceList').innerHTML = ''; 
        }

        try {
            const res = await fetch('/redact', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-Tenant-ID': 'bhashini-demo'},
                body: JSON.stringify({text, domain})
            });
            
            const data = await res.json(); // May contain error detail if 500
            
            if (!res.ok) {
                document.getElementById('outputText').innerHTML = `<span class="text-danger">‚õî ${data.detail}</span>`;
                if(data.trace && showTrace) playTrace(data.trace, true); // Play trace even on fail
                return;
            }

            // Success Path
            document.getElementById('outputText').innerText = data.redacted_text;
            document.getElementById('jsonOutput').innerText = JSON.stringify(data, null, 2);
            document.getElementById('latencyBadge').innerText = `‚ö° ${data.metadata.processing_time_ms} ms`;
            
            if(showTrace && data.trace) {
                playTrace(data.trace, false);
            }
        } catch (e) { alert("System Error: " + e); }
    }

    // --- THE ORCHESTRATION ANIMATION ---
    function playTrace(trace, isError) {
        const list = document.getElementById('traceList');
        let delay = 0;
        
        trace.forEach((step, index) => {
            setTimeout(() => {
                const isLast = index === trace.length - 1;
                let statusClass = "active";
                let icon = "‚è≥";
                
                if (step.status === "Success") { statusClass = "success"; icon = "‚úÖ"; }
                if (step.status.includes("Fail")) { statusClass = "error"; icon = "‚ùå"; }

                const el = document.createElement('div');
                el.className = `trace-step ${statusClass}`;
                el.onclick = () => el.classList.toggle('expanded');
                el.style.animation = "fadeIn 0.3s";
                
                el.innerHTML = `
                    <div class="step-header">
                        <span class="step-name">${icon} ${step.step}</span>
                        <span class="step-time">${step.time_ms} ms</span>
                    </div>
                    <div class="step-desc">${step.details}</div>
                    <div class="step-details">
                        <strong>LOG DATA:</strong><br>
                        ${JSON.stringify(step, null, 2)}
                    </div>
                `;
                list.appendChild(el);
                
                // Auto-scroll to bottom
                list.scrollTop = list.scrollHeight;

            }, delay);
            delay += 300; // The "Simulated" visual delay
        });
    }

    // --- ADMIN LOGIC (Simplified for brevity, same functionality) ---
    async function loadAdminDomains() {
        const res = await fetch('/admin/all-domains');
        const domains = await res.json();
        const list = document.getElementById('adminDomainList');
        list.innerHTML = '';
        domains.forEach(d => {
            const dot = d.is_active ? 'üü¢' : '‚ö™';
            list.innerHTML += `<button class="list-group-item list-group-item-action py-2" onclick="loadDomainConfig('${d.domain_id}')"><div class="d-flex w-100 justify-content-between"><span>${d.domain_id.toUpperCase()}</span><span>${dot}</span></div></button>`;
        });
    }

    async function loadDomainConfig(id) {
        currentDomainId = id;
        document.getElementById('editStatusBadge').innerText = id;
        document.getElementById('editStatusBadge').style.display = 'inline-block';
        const res = await fetch(`/admin/domain-config/${id}`);
        const data = await res.json();
        currentAdminRules = data.policy_json.rules || [];
        renderChecklist();
    }

    function renderChecklist() {
        const tbody = document.getElementById('ruleChecklistBody');
        tbody.innerHTML = '';
        currentAdminRules.forEach((r, idx) => {
            tbody.innerHTML += `<tr><td><input type="checkbox" checked id="chk-${idx}"></td><td class="fw-bold small">${r.entity_type}</td><td><span class="badge bg-light text-dark border">${r.action}</span></td><td class="small text-muted">${JSON.stringify(r.config).substring(0,15)}...</td></tr>`;
        });
    }

    async function generateRegexPreview() {
        const ex = document.getElementById('aiExample').value;
        if(!ex) return alert("Enter example");
        const res = await fetch('/admin/generate-regex', {method:'POST', body:JSON.stringify({example_text:ex}), headers:{'Content-Type':'application/json'}});
        const data = await res.json();
        if(res.ok) document.getElementById('newRuleRegex').value = data.regex;
    }

    function addCustomRuleToUI() {
        const entity = document.getElementById('newRuleEntity').value;
        const regex = document.getElementById('newRuleRegex').value;
        if(!entity || !regex) return alert("Required fields missing");
        currentAdminRules.push({ entity_type: entity, action: document.getElementById('newRuleAction').value, config: {}, custom_regex: regex });
        renderChecklist();
    }

    async function deployDomain() {
        if(!currentDomainId) return alert("Select domain");
        const finalRules = currentAdminRules.filter((_, i) => document.getElementById(`chk-${i}`).checked);
        await fetch('/admin/deploy', {method: 'POST', body: JSON.stringify({ domain_id: currentDomainId, rules: finalRules }), headers: {'Content-Type': 'application/json'}});
        alert("Deployed!"); loadAdminDomains(); loadDomains();
    }
    
    async function createDomain() {
        const id = document.getElementById('newDomainId').value;
        if(!id) return;
        await fetch('/admin/domain', {method:'POST', body:JSON.stringify({domain_id:id, description:""}), headers:{'Content-Type':'application/json'}});
        loadAdminDomains();
    }

    window.onload = function() { loadDomains(); loadAdminDomains(); };
</script>
</body>
</html>