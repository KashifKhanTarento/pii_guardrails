<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI4I PII Guardrail v0.2.3 Control Plane</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding-top: 20px; font-family: 'Segoe UI', sans-serif; }
        .nav-tabs { border-bottom: 2px solid #dee2e6; }
        .nav-tabs .nav-link { color: #495057; font-weight: 500; }
        .nav-tabs .nav-link.active { border-color: #dee2e6 #dee2e6 #f4f6f9; color: #0d6efd; font-weight: 700; background: #f4f6f9; }
        .section-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        
        .section-title { 
            font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; 
            font-weight: 700; color: #6c757d; margin-bottom: 15px; 
            border-bottom: 1px solid #eee; padding-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .rule-list { max-height: 200px; overflow-y: auto; }
        .rule-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8f9fa; }
        .output-box { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; font-family: 'Consolas', monospace; color: #333; min-height: 80px; }
        
        /* Trace Log Styles */
        .trace-container { background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; }
        .trace-header { background: #212529; color: #fff; padding: 12px 15px; font-weight: 700; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
        .trace-body { padding: 0; max-height: 500px; overflow-y: auto; background: #f8f9fa; }
        .trace-step { padding: 12px 15px; border-left: 4px solid transparent; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; position: relative; }
        .trace-step:hover { background: #e9ecef; }
        .trace-step.active { background: #fff; border-left-color: #0d6efd; }
        .trace-step.success { border-left-color: #198754; }
        .trace-step.error { border-left-color: #dc3545; background: #fff5f5; }
        .step-details { display: none; margin-top: 8px; font-size: 0.8rem; background: #333; color: #00ff41; padding: 10px; border-radius: 4px; font-family: 'Consolas', monospace; }
        .trace-step.expanded .step-details { display: block; }
    </style>
</head>
<body>

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center my-4">
        <div>
            <h3 class="fw-bold text-dark mb-0">üõ°Ô∏è AI4I PII Guardrail</h3>
            <span class="badge bg-primary rounded-pill px-3 py-1">v0.2.3 Context-Aware</span>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="traceToggle" checked>
            <label class="form-check-label fw-bold small text-secondary" for="traceToggle">LIVE ORCHESTRATION VIEW</label>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#demo-pane">üéÆ Guardrail Playground</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin-pane">‚öôÔ∏è Policy Manager</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="demo-pane">
            <div class="row gx-4">
                <div class="col-lg-4">
                    <div class="section-card">
                        <div class="section-title">1. Configuration</div>
                        
                        <label class="small fw-bold mb-1">Select Domain</label>
                        <select class="form-select mb-3" id="domainSelect"></select>
                        
                        <label class="small fw-bold mb-1 text-primary">Enforcement Target</label>
                        <select class="form-select mb-3 border-primary" id="targetSelect">
                            <option value="user" selected>üë§ User Response (UX-First)</option>
                            <option value="storage">üíæ Storage / Logs (Strict Mode)</option>
                        </select>

                        <label class="small fw-bold mb-1">Active Rules</label>
                        <div class="rule-list text-muted small" id="policyList">Select a domain...</div>
                    </div>
                    <div class="section-card">
                        <div class="section-title">2. Input Data</div>
                        <textarea class="form-control" id="inputText" rows="6" placeholder="Paste unstructured text here...">Address is No. 32, Bull Temple Road, Bangalore.</textarea>
                        <button class="btn btn-primary w-100 fw-bold mt-3 py-2 shadow-sm" onclick="runRedaction()">üõ°Ô∏è Run Protection</button>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="section-card">
                        <div class="section-title">3. Secure Output</div>
                        <div id="outputText" class="output-box mb-3">...</div>
                        <div class="d-flex justify-content-between align-items-center border-top pt-3">
                            <span class="small text-muted">Latency</span>
                            <span id="latencyBadge" class="badge bg-warning text-dark">0 ms</span>
                        </div>
                    </div>
                    <div class="section-card">
                         <div class="section-title">4. Evidence (Audit Store)</div>
                         <pre id="jsonOutput" class="bg-dark text-success p-3 rounded small" style="max-height: 300px; overflow: auto; font-family: 'Consolas', monospace;">{}</pre>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="trace-container" id="tracePanel" style="display:none">
                        <div class="trace-header">
                            <span>üö¶ Activity Log</span>
                            <span class="badge bg-secondary" style="font-size:0.7rem">LIVE TRACE</span>
                        </div>
                        <div class="trace-body" id="traceList">
                            <div class="p-4 text-center text-muted small">Waiting for request...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="admin-pane">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="section-card h-100 d-flex flex-column">
                        <div class="section-title">1. Domain Inventory</div>
                        <div class="list-group flex-grow-1 overflow-auto mb-3" id="adminDomainList" style="max-height: 400px;"></div>
                        <button class="btn btn-dark w-100 fw-bold mb-3" id="btnApply" onclick="applyActivation()" disabled>‚úÖ Apply Active Domains</button>
                        <hr>
                        <input type="text" class="form-control mb-2 form-control-sm" id="newDomainId" placeholder="New Domain ID">
                        <button class="btn btn-outline-dark btn-sm w-100" onclick="createDomain()">+ Create Scope</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="section-card h-100">
                        <div class="section-title">
                            <span>2. Configure Rules</span>
                            <span class="badge bg-warning text-dark" id="editStatusBadge" style="display:none; font-size: 0.7em;">Editing</span>
                        </div>
                        <div class="border rounded p-2 mb-3 bg-light" style="height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light"><tr><th width="30"></th><th>Entity</th><th>Action</th><th>Config</th></tr></thead>
                                <tbody id="ruleChecklistBody"></tbody>
                            </table>
                        </div>
                        <div class="card bg-white border p-2 mb-3">
                            <h6 class="small fw-bold text-primary">Add Custom Rule</h6>
                            <div class="row g-2">
                                <div class="col-3"><input type="text" class="form-control form-control-sm" id="newRuleEntity" placeholder="Entity"></div>
                                <div class="col-2"><select class="form-select form-select-sm" id="newRuleAction"><option>REDACT_TAG</option><option>MASK</option><option>HASH</option></select></div>
                                <div class="col-7"><div class="input-group input-group-sm"><input type="text" class="form-control" id="aiExample" placeholder="Example"><button class="btn btn-outline-secondary" onclick="generateRegexPreview()">Gen Regex</button></div></div>
                            </div>
                            <input type="text" class="form-control form-control-sm mt-2 bg-light font-monospace" id="newRuleRegex" readonly>
                            <button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="addCustomRuleToUI()">+ Add to List</button>
                        </div>
                        <button class="btn btn-success w-100 fw-bold" onclick="saveRules()">üíæ Save Configuration</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentAdminRules = []; 
    let currentDomainId = null;

    async function loadDomains() {
        try {
            const res = await fetch('/domains');
            const domains = await res.json();
            const sel = document.getElementById('domainSelect');
            const currentSelection = sel.value;
            sel.innerHTML = '';
            if (domains.length === 0) {
                sel.innerHTML = '<option value="">No Active Domains</option>';
            } else {
                domains.forEach(d => {
                    const selected = d === currentSelection ? 'selected' : '';
                    sel.innerHTML += `<option value="${d}" ${selected}>${d.toUpperCase()}</option>`;
                });
            }
            loadPolicy();
        } catch(e) { console.error(e); }
    }

    async function loadPolicy() {
        const domain = document.getElementById('domainSelect').value;
        const list = document.getElementById('policyList');
        list.innerHTML = '';
        if (!domain || domain === 'No Active Domains') return;
        
        const res = await fetch(`/policy/${domain}`);
        const data = await res.json();
        if(data.rules) {
            data.rules.forEach(r => {
                let badge = r.action === "MASK" ? "bg-dark" : (r.action === "HASH" ? "bg-danger" : "bg-secondary");
                list.innerHTML += `<div class="rule-item"><span>${r.entity_type}</span><span class="badge ${badge}">${r.action}</span></div>`;
            });
        }
    }

    async function runRedaction() {
        const text = document.getElementById('inputText').value;
        const domain = document.getElementById('domainSelect').value;
        const target = document.getElementById('targetSelect').value; // GET TARGET
        const showTrace = document.getElementById('traceToggle').checked;
        
        if (!domain) return alert("Activate a domain first.");
        
        document.getElementById('outputText').innerText = "Processing...";
        if(showTrace) {
            document.getElementById('tracePanel').style.display = 'block';
            document.getElementById('traceList').innerHTML = ''; 
        }

        try {
            const res = await fetch('/redact', {
                method: 'POST',
                // SEND HEADERS: Includes X-Target for Context Awareness
                headers: {
                    'Content-Type': 'application/json', 
                    'X-Tenant-ID': 'bhashini-demo',
                    'X-Target': target 
                },
                body: JSON.stringify({text, domain})
            });
            const data = await res.json();
            
            if (!res.ok) {
                document.getElementById('outputText').innerHTML = `<span class="text-danger">‚õî ${data.detail}</span>`;
                if(data.trace && showTrace) playTrace(data.trace, true);
                return;
            }

            document.getElementById('outputText').innerText = data.redacted_text;
            document.getElementById('latencyBadge').innerText = `‚ö° ${data.metadata.processing_time_ms} ms`;
            
            // Populate JSON log
            const jsonEl = document.getElementById('jsonOutput');
            if(jsonEl) jsonEl.innerText = JSON.stringify(data, null, 2);

            if(showTrace && data.trace) playTrace(data.trace, false);
        } catch (e) { alert("System Error: " + e); }
    }

    function playTrace(trace, isError) {
        const list = document.getElementById('traceList');
        let delay = 0;
        trace.forEach((step) => {
            setTimeout(() => {
                let statusClass = "active";
                let icon = "‚è≥";
                if (step.status === "Success" || step.status === "Applied") { statusClass = "success"; icon = "‚úÖ"; }
                if (step.status.includes("Fail")) { statusClass = "error"; icon = "‚ùå"; }

                const el = document.createElement('div');
                el.className = `trace-step ${statusClass}`;
                el.onclick = () => el.classList.toggle('expanded');
                el.innerHTML = `<div class="step-header"><span class="step-name">${icon} ${step.step}</span><span class="step-time">${step.time_ms || 0} ms</span></div><div class="step-desc">${step.details}</div><div class="step-details">LOG: ${JSON.stringify(step, null, 2)}</div>`;
                list.appendChild(el);
                list.scrollTop = list.scrollHeight;
            }, delay);
            delay += 300;
        });
    }

    async function loadAdminDomains() {
        const res = await fetch('/admin/all-domains');
        const domains = await res.json();
        const list = document.getElementById('adminDomainList');
        list.innerHTML = '';
        domains.forEach(d => {
            const checked = d.is_active ? 'checked' : '';
            list.innerHTML += `
                <div class="list-group-item d-flex align-items-center justify-content-between p-2">
                    <div class="d-flex align-items-center">
                        <input class="form-check-input me-2 domain-check" type="checkbox" value="${d.domain_id}" ${checked} onchange="updateApplyButton()">
                        <span style="cursor:pointer; font-weight:500" onclick="loadDomainConfig('${d.domain_id}')">${d.domain_id.toUpperCase()}</span>
                    </div>
                    <button class="btn btn-sm btn-light text-primary" title="Edit Config" onclick="loadDomainConfig('${d.domain_id}')">‚úèÔ∏è</button>
                </div>
            `;
        });
        updateApplyButton();
    }

    function updateApplyButton() {
        const checks = document.querySelectorAll('.domain-check:checked');
        const btn = document.getElementById('btnApply');
        btn.disabled = checks.length === 0;
        btn.innerText = `‚úÖ Apply Active Domains (${checks.length})`;
    }

    async function applyActivation() {
        const checks = document.querySelectorAll('.domain-check:checked');
        const ids = Array.from(checks).map(c => c.value);
        const res = await fetch('/admin/activate-domains', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ domain_ids: ids })
        });
        if(res.ok) { alert("Deployment Updated!"); loadDomains(); } 
        else alert("Failed.");
    }

    async function loadDomainConfig(id) {
        currentDomainId = id;
        document.getElementById('editStatusBadge').innerText = id;
        document.getElementById('editStatusBadge').style.display = 'block';
        const res = await fetch(`/admin/domain-config/${id}`);
        const data = await res.json();
        currentAdminRules = data.policy_json.rules || [];
        renderChecklist();
    }

    function renderChecklist() {
        const tbody = document.getElementById('ruleChecklistBody');
        tbody.innerHTML = '';
        currentAdminRules.forEach((r, idx) => {
            tbody.innerHTML += `<tr><td><input type="checkbox" checked id="chk-${idx}"></td><td class="fw-bold small">${r.entity_type}</td><td><span class="badge bg-light text-dark border">${r.action}</span></td><td class="small text-muted">${JSON.stringify(r.config).substring(0,15)}...</td></tr>`;
        });
    }
    
    async function saveRules() {
        if(!currentDomainId) return alert("Select domain");
        const finalRules = currentAdminRules.filter((_, i) => document.getElementById(`chk-${i}`).checked);
        await fetch('/admin/deploy', {
            method: 'POST', 
            body: JSON.stringify({ domain_id: currentDomainId, rules: finalRules }), 
            headers: {'Content-Type': 'application/json'}
        });
        alert("Saved. Click 'Apply' to Activate.");
        loadAdminDomains();
    }

    async function createDomain() {
        const id = document.getElementById('newDomainId').value;
        if(!id) return;
        await fetch('/admin/domain', {method:'POST', body:JSON.stringify({domain_id:id, description:""}), headers:{'Content-Type':'application/json'}});
        loadAdminDomains();
        document.getElementById('newDomainId').value = '';
    }

    async function generateRegexPreview() {
        const ex = document.getElementById('aiExample').value;
        const res = await fetch('/admin/generate-regex', {method:'POST', body:JSON.stringify({example_text:ex}), headers:{'Content-Type':'application/json'}});
        const data = await res.json();
        if(res.ok) document.getElementById('newRuleRegex').value = data.regex;
    }

    function addCustomRuleToUI() {
        const entity = document.getElementById('newRuleEntity').value;
        const regex = document.getElementById('newRuleRegex').value;
        if(!entity || !regex) return alert("Missing fields");
        currentAdminRules.push({ entity_type: entity, action: document.getElementById('newRuleAction').value, config: {}, custom_regex: regex });
        renderChecklist();
    }

    window.onload = function() { 
        loadDomains(); 
        loadAdminDomains();
        document.getElementById('domainSelect').addEventListener('change', loadPolicy);
    };
</script>
</body>
</html>